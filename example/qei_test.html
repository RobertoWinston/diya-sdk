
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Simple chart with C3 - in 5 minutes! </title>
  
  <!-- Here are all the javascripts and css that you need, you can download them or linked them like here -->
  <script type="text/javascript" src="../node_modules/c3/node_modules/d3/d3.min.js"></script>
<!--
  <script type="text/javascript" src="../node_modules/d3/d3.min.js"></script>
-->
  <script type="text/javascript" src="../node_modules/c3/c3.min.js"></script>
  <link href="../node_modules/c3/c3.css" rel="stylesheet" type="text/css">
  
<!--
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.js"></script>
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/c3/0.1.29/c3.js"></script>
  <link href="http://cdnjs.cloudflare.com/ajax/libs/c3/0.1.29/c3.css" rel="stylesheet" type="text/css">
-->


<script type="text/javascript" src="../dist/diya-sdk.js"></script>




</head>
<body>

<!-- You need an element with an id called "chart" to set a place where your chart will render-->
<div id="chart"></div>
  
  <script>
var chart = c3.generate({
    data: {
        x: 'x',
//        xFormat: '%Y%m%d', // 'xFormat' can be used as custom format of 'x'
        columns: [
            ['x', '2013-01-01', '2013-01-02', '2013-01-03', '2013-01-04', '2013-01-05', '2013-01-06'],
//            ['x', '20130101', '20130102', '20130103', '20130104', '20130105', '20130106'],
            ['data1', 30, 200, 100, 400, 150, 250],
            ['data2', 130, 340, 200, 500, 250, 350]
        ]
    },
    bindto:'#chart',
    axis: {
        x: {
            type: 'timeseries',
            tick: {
                format: '%Y-%m-%d'
            }
        }
    }
});

var displayConfig={};
var dataModel={};

	function onClientAuthenticationFailure(){
		console.log("Cannot authenticate client !");
	}

	function onClientAuthenticated(node){
		console.log("Client authenticated !");

		node.get({
			service: "qei",
			func: "DataRequest",
			data: "test"
			}, function(data){
				console.log(JSON.stringify(data));
				for (var n in data) {
					if(n != "header") {
						dataModel[n]={};
						dataModel[n].sampling=data.header.sampling;
						dataModel[n].frame=data[n].frame;
						dataModel[n].data=[];
					}
				}

				console.log(JSON.stringify(dataModel));

				/* update internal model for display */

				node.listen({
						service: "qei",
						func: "SubscribeQei"
					},printVals);
			});
	}

	

	/** 
	*		Display values 
	*/ 
	/* should be displayed in the framework not in console only... */
	function printVals(res){
		/* infos are in data */
		/* VERY BADLY CODED - TO BE IMPROVED */
		console.log(JSON.stringify(res));

		/** update internal model */
		_getDataModelFromRecv(res);
		
		console.log("In memory:  DC:"+JSON.stringify(displayConfig));
		console.log("DM: "+JSON.stringify(dataModel));
	}


	/**
	 * Update internal model with received data
	 * @param  {Object} res data received from DiyaNode by websocket
	 * @return {[type]}     [description]
	 */
	function _getDataModelFromRecv(res){
		var data = res.data;
		if(data) {
			if(!data.header.sampling) data.header.sampling=1;
			for (var n in data) {
				if(n != "header") {
					console.log(n);
					/* increase size of data if necessary */
					if(data.header.sampling>dataModel[n].sampling) {
						dataModel[n].data=new Array(data.header.sampling);
					}
					/* update nb of samples stored */
					dataModel[n].sampling=data.header.sampling;

					/* update dataFrame */
					dataModel[n].frame=data[n].frame;

					/* decode data to Float32Array*/
					var buf = base64DecToArr(data[n].data, 4); 
					console.log(JSON.stringify(buf));
					var mydata = new Float32Array(buf);
					console.log(JSON.stringify(mydata));
				}
			}
		}
		else {
			console.err("No Data to read !");
		}
	}

/*\
|*|
|*|  utilitaires de manipulations de chaînes base 64 / binaires / UTF-8
|*|
|*|  https://developer.mozilla.org/fr/docs/Décoder_encoder_en_base64
|*|
\*/
	/* Decoder un tableau d'octets depuis une chaîne en base64 */
	function b64ToUint6 (nChr) {
	  return nChr > 64 && nChr < 91 ?
	      nChr - 65
	    : nChr > 96 && nChr < 123 ?
	      nChr - 71
	    : nChr > 47 && nChr < 58 ?
	      nChr + 4
	    : nChr === 43 ?
	      62
	    : nChr === 47 ?
	      63
	    :
	      0;
	}
	/**
	 * Decode base64 string to UInt8Array
	 * @param  {String} sBase64     base64 coded string
	 * @param  {int} nBlocksSize size of blocks of bytes to be read. Output byteArray length will be a multiple of this value.
	 * @return {Uint8Array}             tab of decoded bytes
	 */
	function base64DecToArr (sBase64, nBlocksSize) {
		var
		sB64Enc = sBase64.replace(/[^A-Za-z0-9\+\/]/g, ""), nInLen = sB64Enc.length,
		nOutLen = nBlocksSize ? Math.ceil((nInLen * 3 + 1 >> 2) / nBlocksSize) * nBlocksSize : nInLen * 3 + 1 >> 2,
		buffer = new ArrayBuffer(nOutLen), taBytes = new Uint8Array(buffer);

		for (var nMod3, nMod4, nUint24 = 0, nOutIdx = 0, nInIdx = 0; nInIdx < nInLen; nInIdx++) {
			nMod4 = nInIdx & 3; /* n mod 4 */
			nUint24 |= b64ToUint6(sB64Enc.charCodeAt(nInIdx)) << 18 - 6 * nMod4;
			if (nMod4 === 3 || nInLen - nInIdx === 1) {
			  for (nMod3 = 0; nMod3 < 3 && nOutIdx < nOutLen; nMod3++, nOutIdx++) {
			    taBytes[nOutIdx] = nUint24 >>> (16 >>> nMod3 & 24) & 255;
			  }
			  nUint24 = 0;

			}
		}
		console.log("u8int : "+JSON.stringify(taBytes));
	  	return buffer;
	}




	//var client = new diya.DiyaClient("ws://127.0.0.1:1234", "admin", "pass");

	//client.createSession(onClientAuthenticated, onClientAuthenticationFailure);

</script>
  
</body>
</html>





