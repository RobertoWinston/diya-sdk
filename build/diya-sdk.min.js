!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.d1=e()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"function"==typeof Object.create?module.exports=function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],2:[function(require,module,exports){function EventEmitter(){EventEmitter.init.call(this)}var util={};util.isObject=function(arg){return"object"==typeof arg&&null!==arg},util.isNumber=function(arg){return"number"==typeof arg},util.isUndefined=function(arg){return void 0===arg},util.isFunction=function(arg){return"function"==typeof arg},module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.init=function(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(n){if(!util.isNumber(n)||0>n||isNaN(n))throw TypeError("n must be a positive number");return this._maxListeners=n,this},EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(this._events||(this._events={}),"error"===type&&!this._events.error)throw er=arguments[1],er instanceof Error?er:Error('Uncaught, unspecified "error" event.');if(handler=this._events[type],util.isUndefined(handler))return!1;if(util.isFunction(handler))switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:for(len=arguments.length,args=new Array(len-1),i=1;len>i;i++)args[i-1]=arguments[i];handler.apply(this,args)}else if(util.isObject(handler)){for(len=arguments.length,args=new Array(len-1),i=1;len>i;i++)args[i-1]=arguments[i];for(listeners=handler.slice(),len=listeners.length,i=0;len>i;i++)listeners[i].apply(this,args)}return!0},EventEmitter.prototype.addListener=function(type,listener){var m;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",type,util.isFunction(listener.listener)?listener.listener:listener),this._events[type]?util.isObject(this._events[type])?this._events[type].push(listener):this._events[type]=[this._events[type],listener]:this._events[type]=listener,util.isObject(this._events[type])&&!this._events[type].warned){var m;m=util.isUndefined(this._maxListeners)?EventEmitter.defaultMaxListeners:this._maxListeners,m&&m>0&&this._events[type].length>m&&(this._events[type].warned=!0,util.isFunction(console.error)&&console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[type].length),util.isFunction(console.trace)&&console.trace())}return this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(type,listener){function g(){this.removeListener(type,g),fired||(fired=!0,listener.apply(this,arguments))}if(!util.isFunction(listener))throw TypeError("listener must be a function");var fired=!1;return g.listener=listener,this.on(type,g),this},EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;if(list=this._events[type],length=list.length,position=-1,list===listener||util.isFunction(list.listener)&&list.listener===listener)delete this._events[type],this._events.removeListener&&this.emit("removeListener",type,listener);else if(util.isObject(list)){for(i=length;i-->0;)if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}if(0>position)return this;1===list.length?(list.length=0,delete this._events[type]):list.splice(position,1),this._events.removeListener&&this.emit("removeListener",type,listener)}return this},EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[type]&&delete this._events[type],this;if(0===arguments.length){for(key in this._events)"removeListener"!==key&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events={},this}if(listeners=this._events[type],util.isFunction(listeners))this.removeListener(type,listeners);else if(Array.isArray(listeners))for(;listeners.length;)this.removeListener(type,listeners[listeners.length-1]);return delete this._events[type],this},EventEmitter.prototype.listeners=function(type){var ret;return ret=this._events&&this._events[type]?util.isFunction(this._events[type])?[this._events[type]]:this._events[type].slice():[]},EventEmitter.listenerCount=function(emitter,type){var ret;return ret=emitter._events&&emitter._events[type]?util.isFunction(emitter._events[type])?1:emitter._events[type].length:0}},{}],3:[function(require,module,exports){function DiyaNode(){EventEmitter.call(this),this._status="closed",this._addr=null,this._socket=null,this._nextId=0,this._connectionDeferred=null,this._disconnectionDeferred=null,this._pendingMessages=[],this._peers=[],this._reconnectTimeout=1e3,this._connectTimeout=5e3}function SocketHandler(WSocket,addr,timeout){var that=this;this.addr=addr,WSocket?this._WSocket=WSocket:this._WSocket||(this._WSocket=window.WebSocket),WSocket=this._WSocket,this._status="opening";try{this._socket=0===addr.indexOf("wss://")?new WSocket(addr,void 0,{rejectUnauthorized:!1}):new WSocket(addr),this._socketOpenCallback=this._onopen.bind(this),this._socketCloseCallback=this._onclose.bind(this),this._socketMessageCallback=this._onmessage.bind(this),this._socket.addEventListener("open",this._socketOpenCallback),this._socket.addEventListener("close",this._socketCloseCallback),this._socket.addEventListener("message",this._socketMessageCallback),this._socket.addEventListener("error",function(err){Logger.error("[WS] error : "+JSON.stringify(err)),that._socket.close()}),setTimeout(function(){"opened"!==that._status&&"closed"!==that._status&&(Logger.log("d1: "+that.addr+" timed out while connecting"),that.close(),that.emit("timeout",that._socket))},timeout)}catch(e){throw Logger.error(e.stack),that.close(),e}}var EventEmitter=require("node-event-emitter"),inherits=require("inherits"),DEBUG=!1,Logger={log:function(message){DEBUG&&console.log(message)},error:function(message){DEBUG&&console.error(message)}};inherits(DiyaNode,EventEmitter),DiyaNode.prototype.addr=function(){return this._addr},DiyaNode.prototype.peers=function(){return this._peers},DiyaNode.prototype.self=function(){return this._self},DiyaNode.prototype.setSecured=function(bSecured){this._secured=bSecured!==!1},DiyaNode.prototype.setWSocket=function(WSocket){this._WSocket=WSocket},DiyaNode.prototype.connect=function(addr,WSocket){var that=this;if(this.bDontReconnected=!1,WSocket?this._WSocket=WSocket:this._WSocket||(this._WSocket=window.WebSocket),WSocket=this._WSocket,0===addr.indexOf("ws://")&&this._secured)return Q.reject("Please use a secured connection ("+addr+")");if(0===addr.indexOf("wss://")&&this._secured===!1)return Q.reject("Please use a non-secured connection ("+addr+")");if(0!==addr.indexOf("ws://")&&0!==addr.indexOf("wss://")&&(addr=this._secured?"wss://"+addr:"ws://"+addr),this._addr===addr){if("opened"===this._status)return Q(this.self());if(this._connectionDeferred&&this._connectionDeferred.promise&&this._connectionDeferred.promise.isPending())return this._connectionDeferred.promise}return this.close().then(function(){that._addr=addr,that._connectionDeferred=Q.defer(),Logger.log("d1: connect to "+that._addr);var sock=new SocketHandler(WSocket,that._addr,that._connectTimeout);return that._socketHandler||(that._socketHandler=sock),sock.on("open",function(){return that._socketHandler!==sock?void console.log("[d1] Websocket responded but already connected to a different one"):(that._socketHandler=sock,that._status="opened",void that._setupPingResponse())}),sock.on("close",function(){that._socketHandler===sock&&(that._socketHandler=null,that._status="closed",that._stopPingResponse(),that._onclose(),that._connectionDeferred&&(that._connectionDeferred.reject("closed"),that._connectionDeferred=null))}),sock.on("timeout",function(){that._socketHandler===sock&&(that._socketHandler=null,that._status="closed",that._connectionDeferred&&(that._connectionDeferred.reject("closed"),that._connectionDeferred=null))}),sock.on("message",function(message){that._onmessage(message)}),that._connectionDeferred.promise})},DiyaNode.prototype.disconnect=function(){return this.bDontReconnected=!0,this.close()},DiyaNode.prototype.close=function(){return this._stopPingResponse(),this._socketHandler?this._socketHandler.close():Q()},DiyaNode.prototype.isConnected=function(){return this._socketHandler&&this._socketHandler.isConnected()},DiyaNode.prototype.request=function(params,callback,timeout,options){var that=this;if(options||(options={}),params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedRequest";params={service:_params[0],func:_params[1]}}if(!params.service)return Logger.error("No service defined for request !"),!1;var message=this._createMessage(params,"Request");return this._appendMessage(message,callback),"function"==typeof options.callback_partial&&(this._pendingMessages[message.id].callback_partial=options.callback_partial),message.options=options,!isNaN(timeout)&&timeout>0&&setTimeout(function(){var handler=that._removeMessage(message.id);handler&&that._notifyListener(handler,"Timeout exceeded ("+timeout+"ms) !")},timeout),this._send(message)?!0:(this._removeMessage(message.id),console.error("Cannot send request !"),!1)},DiyaNode.prototype.subscribe=function(params,callback){if(params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedRequest";params={service:_params[0],func:_params[1]}}if(!params.service)return Logger.error("No service defined for subscription !"),-1;var message=this._createMessage(params,"Subscription");return this._appendMessage(message,callback),this._send(message)?message.id:(this._removeMessage(message.id),Logger.error("Cannot send subscription !"),-1)},DiyaNode.prototype.unsubscribe=function(subId){if(this._pendingMessages[subId]&&"Subscription"===this._pendingMessages[subId].type){var subscription=this._removeMessage(subId),message=this._createMessage({target:subscription.target,data:{subId:subId}},"Unsubscribe");return this._send(message)?!0:(Logger.error("Cannot send unsubscribe !"),!1)}return!1},DiyaNode.prototype._appendMessage=function(message,callback){this._pendingMessages[message.id]={callback:callback,type:message.type,target:message.target}},DiyaNode.prototype._removeMessage=function(messageId){var handler=this._pendingMessages[messageId];return handler?(delete this._pendingMessages[messageId],handler):null},DiyaNode.prototype._clearMessages=function(err,data){for(var messageId in this._pendingMessages){var handler=this._removeMessage(messageId);this._notifyListener(handler,err,data)}},DiyaNode.prototype._clearPeers=function(){for(;this._peers.length;)this.emit("peer-disconnected",this._peers.pop())},DiyaNode.prototype._getMessageHandler=function(messageId){var handler=this._pendingMessages[messageId];return handler?handler:null},DiyaNode.prototype._notifyListener=function(handler,error,data){if(handler&&"function"==typeof handler.callback){error=error?error:null,data=data?data:null;try{handler.callback(error,data)}catch(e){console.log(e.stack)}}},DiyaNode.prototype._send=function(message){return this._socketHandler.send(message)},DiyaNode.prototype._setupPingResponse=function(){function checkPing(){var curTime=(new Date).getTime();curTime-that._lastPing>that._pingTimeout?(that._forceClose(),Logger.log("d1:  timed out !")):(Logger.log("d1: last ping ok"),that._pingSetTimeoutId=setTimeout(checkPing,Math.round(that._pingTimeout/2.1)))}var that=this;this._pingTimeout=15e3,this._lastPing=(new Date).getTime(),checkPing()},DiyaNode.prototype._stopPingResponse=function(){clearTimeout(this._pingSetTimeoutId)},DiyaNode.prototype._forceClose=function(){this._socketHandler.close(),this._onclose()},DiyaNode.prototype._onmessage=function(message){if(isNaN(message.id))return this._handleInternalMessage(message);var handler=this._getMessageHandler(message.id);if(handler)switch(handler.type){case"Request":this._handleRequest(handler,message);break;case"Subscription":this._handleSubscription(handler,message)}},DiyaNode.prototype._onclose=function(){var that=this;this._clearMessages("PeerDisconnected"),this._clearPeers(),Logger.log("d1: connection lost, try reconnecting"),setTimeout(function(){that.connect(that._addr,that._WSocket)["catch"](function(err){})},that._reconnectTimeout),this.emit("close",this._addr)},DiyaNode.prototype._handleInternalMessage=function(message){switch(message.type){case"PeerConnected":this._handlePeerConnected(message);break;case"PeerDisconnected":this._handlePeerDisconnected(message);break;case"Handshake":this._handleHandshake(message);break;case"Ping":this._handlePing(message)}},DiyaNode.prototype._handlePing=function(message){message.type="Pong",this._lastPing=(new Date).getTime(),this._send(message)},DiyaNode.prototype._handleHandshake=function(message){if(void 0===message.peers||"string"!=typeof message.self)return void Logger.error("Missing arguments for Handshake message, dropping...");this._self=message.self;for(var i=0;i<message.peers.length;i++)this._peers.push(message.peers[i]),this.emit("peer-connected",message.peers[i]);this._connectionDeferred.resolve(this.self()),this.emit("open",this._addr),this._status="opened",this._connectionDeferred=null},DiyaNode.prototype._handlePeerConnected=function(message){return void 0===message.peerId?void Logger.error("Missing arguments for PeerConnected message, dropping..."):(this._peers.push(message.peerId),void this.emit("peer-connected",message.peerId))},DiyaNode.prototype._handlePeerDisconnected=function(message){if(void 0===message.peerId)return void Logger.error("Missing arguments for PeerDisconnected Message, dropping...");for(var messageId in this._pendingMessages){var handler=this._getMessageHandler(messageId);handler&&handler.target===message.peerId&&(this._removeMessage(messageId),this._notifyListener(handler,"PeerDisconnected",null))}for(var i=this._peers.length-1;i>=0;i--)if(this._peers[i]===message.peerId){this._peers.splice(i,1);break}this.emit("peer-disconnected",message.peerId)},DiyaNode.prototype._handleRequest=function(handler,message){if("PartialAnswer"===message.type){if("function"==typeof this._pendingMessages[message.id].callback_partial){var error=message.error?message.error:null,data=message.data?message.data:null;this._pendingMessages[message.id].callback_partial(error,data)}}else this._removeMessage(message.id),this._notifyListener(handler,message.error,message.data)},DiyaNode.prototype._handleSubscription=function(handler,message){"closed"===message.result&&(this._removeMessage(message.id),message.error="SubscriptionClosed"),this._notifyListener(handler,message.error,message.data?message.data:null)},inherits(SocketHandler,EventEmitter),SocketHandler.prototype.close=function(){return this._disconnectionDeferred&&this._disconnectionDeferred.promise?this._disconnectionDeferred.promise:(this._disconnectionDeferred=Q.defer(),this._status="closing",this._socket&&this._socket.close(),this._disconnectionDeferred.promise)},SocketHandler.prototype.send=function(message){try{var data=JSON.stringify(message)}catch(err){return console.error("Cannot serialize message"),!1}try{this._socket.send(data)}catch(err){return console.error("Cannot send message"),console.error(err),!1}return!0},SocketHandler.prototype.isConnected=function(){return this._socket.readyState==this._WSocket.OPEN&&"opened"===this._status},SocketHandler.prototype._onopen=function(){this._status="opened",this.emit("open",this._socket)},SocketHandler.prototype._onclose=function(){this._status="closed",this.unregisterCallbacks(),this.emit("close",this._socket),this._disconnectionDeferred&&this._disconnectionDeferred.promise&&this._disconnectionDeferred.resolve()},SocketHandler.prototype._onmessage=function(evt){try{var message=JSON.parse(evt.data);this.emit("message",message)}catch(err){throw Logger.error("[WS] cannot parse message, dropping..."),err}},SocketHandler.prototype.unregisterCallbacks=function(){this._socket&&"function"==typeof this._socket.removeEventListener?(this._socket.removeEventListener("open",this._socketOpenCallback),this._socket.removeEventListener("close",this._socketCloseCallback),this._socket.removeEventListener("message",this._socketMessageCallback)):this._socket&&"function"==typeof this._socket.removeAllListeners&&this._socket.removeAllListeners()},DiyaNode.prototype._createMessage=function(params,type){return!params||!type||"Request"!==type&&"Subscription"!==type&&"Unsubscribe"!==type?null:{type:type,id:this._generateId(),service:params.service,target:params.target,func:params.func,obj:params.obj,data:params.data}},DiyaNode.prototype._generateId=function(){var id=this._nextId;return this._nextId++,id},module.exports=DiyaNode},{inherits:1,"node-event-emitter":2}],4:[function(require,module,exports){function d1(selector){return new DiyaSelector(selector)}function DiyaSelector(selector){EventEmitter.call(this),this._selector=selector,this._listenerCount=0,this._listenCallback=null,this._callbackAttached=!1}function match(selector,str){return selector?"#self"===selector?connection&&str===connection.self():selector.not?!match(selector.not,str):"String"===selector.constructor.name?matchString(selector,str):"RegExp"===selector.constructor.name?matchRegExp(selector,str):Array.isArray(selector)?matchArray(selector,str):!1:!1}function matchString(selector,str){return selector===str}function matchRegExp(selector,str){return str.match(selector)}function matchArray(selector,str){for(var i=0;i<selector.length;i++)if(selector[i]===str)return!0;return!1}function Subscription(selector,params,callback,options){var that=this;return this.selector=selector,this.params=params,this.callback=callback,this.options=options,this.subIds=[],this.doSubscribe=function(peerId){that.subIds.push(that._addSubscription(peerId)),that.state="open"},this.options&&this.options.auto?this.selector.on("peer-connected",this.doSubscribe):this.selector.each(this.doSubscribe),this}var EventEmitter=require("node-event-emitter"),inherits=require("inherits"),DiyaNode=require("./DiyaNode"),connection=new DiyaNode,_user=(new EventEmitter,null),_pass=null,_authenticated=!1;d1.DiyaNode=DiyaNode,d1.DiyaSelector=DiyaSelector,d1.connect=function(addr,WSocket){return connection.connect(addr,WSocket)},d1.disconnect=function(){return connection.disconnect()},d1.isConnected=function(){return connection.isConnected()},d1.peers=function(){return connection.peers()},d1.self=function(){return connection.self()},d1.addr=function(){return connection.addr()},d1.user=function(){return _user},d1.pass=function(){return _pass},d1.isAuthenticated=function(){return _authenticated},d1.tryConnect=function(servers,WSocket){function tc(i){d1.connect(servers[i],WSocket).then(function(e){return deferred.resolve(servers[i])})["catch"](function(e){d1.disconnect().then(function(){return i++,i<servers.length?void setTimeout(function(){tc(i)},100):deferred.reject("Timeout")})})}var deferred=Q.defer();return tc(0),deferred.promise},d1.currentServer=function(){return connection._addr},d1.on=function(event,callback){return connection.on(event,callback),d1},d1.connectAsUser=function(ip,user,password,WSocket){return d1.connect(ip,WSocket).then(function(){return d1("#self").auth(user,password)})},d1.deauthenticate=function(){_authenticated=!1,_user=null,_pass=null},d1.setSecured=function(bSecured){connection.setSecured(bSecured)},d1.isSecured=function(){return connection._secured},d1.setWSocket=function(WSocket){connection.setWSocket(WSocket)},d1.selfConnect=function(port,signature,WSocket){return d1.connect("ws://localhost:"+port,WSocket).then(function(){var deferred=Q.defer();return d1("#self").request({service:"peerAuth",func:"SelfAuthenticate",data:{signature:signature}},function(peerId,err,data){return err?deferred.reject(err):void(data&&data.authenticated?(_authenticated=!0,_user="#DiyaNode#"+peerId,deferred.resolve()):(_authenticated=!1,deferred.reject("AccessDenied")))}),deferred.promise})},inherits(DiyaSelector,EventEmitter),DiyaSelector.prototype.select=function(){return this._select()},DiyaSelector.prototype.each=function(cb){for(var peers=this._select(),i=0;i<peers.length;i++)cb.bind(this)(peers[i]);return this},DiyaSelector.prototype.request=function(params,callback,timeout,options){if(!connection)return this;if(options||(options={}),params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedRequest";params={service:_params[0],func:_params[1]}}var nbAnswers=0,nbExpected=this._select().length;return this.each(function(peerId){params.target=peerId;var opts={};for(var i in options)opts[i]=options[i];"function"==typeof opts.callback_partial&&(opts.callback_partial=function(err,data){options.callback_partial(peerId,err,data)}),connection.request(params,function(err,data){"function"==typeof callback&&callback(peerId,err,data),nbAnswers++,nbAnswers==nbExpected&&options.bNotifyWhenFinished&&callback(null,err,"##END##")},timeout,opts)})},DiyaSelector.prototype.subscribe=function(params,callback,options){if(params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedSubscription";params={service:_params[0],func:_params[1]}}return new Subscription(this,params,callback,options)},DiyaSelector.prototype.unsubscribe=function(subscription){return Array.isArray(subscription)||!subscription.close?this.__old_deprecated_unsubscribe(subscription):subscription.close()},DiyaSelector.prototype.auth=function(user,password,callback,timeout){"function"==typeof callback&&(callback=callback.bind(this));var deferred=Q.defer();return this.request({service:"auth",func:"Authenticate",data:{user:user,password:password}},function(peerId,err,data){return"ServiceNotFound"===err?void("function"==typeof callback?callback(peerId,!0):deferred.reject(err)):void(!err&&data&&data.authenticated?(_authenticated=!0,_user=user,_pass=password,"function"==typeof callback?callback(peerId,!0):deferred.resolve()):(_authenticated=!1,"function"==typeof callback?callback(peerId,!1):deferred.reject("AccessDenied")))},timeout),deferred.promise},DiyaSelector.prototype._select=function(selectorFunction){var that=this;return connection?connection.peers().filter(function(peerId){return match(that._selector,peerId)}):[]},DiyaSelector.prototype._on=DiyaSelector.prototype.on,DiyaSelector.prototype.on=function(type,callback){callback.___DiyaSelector_hidden_wrapper=function(peerId){match(this._selector,peerId)&&this.emit(type,peerId)},connection.on(type,callback.___DiyaSelector_hidden_wrapper);var ret=this._on(type,callback);if("peer-connected"===type&&connection.isConnected())for(var peers=connection.peers(),i=0;i<peers.length;i++)match(this._selector,peers[i])&&callback(peers[i]);return ret},DiyaSelector.prototype._removeListener=DiyaSelector.prototype.removeListener,DiyaSelector.prototype.removeListener=function(type,callback){callback.___DiyaSelector_hidden_wrapper&&connection.removeListener(type,callback.___DiyaSelector_hidden_wrapper),this._removeListener(type,callback)},Subscription.prototype.close=function(){for(var i=0;i<this.subIds.length;i++)connection.unsubscribe(this.subIds[i]);this.subIds=[],this.selector.removeListener("peer-connected",this.doSubscribe),this.state="closed"},Subscription.prototype._addSubscription=function(peerId){var that=this;params={};for(var k in this.params)params[k]=this.params[k];params.target=peerId;var subId=connection.subscribe(params,function(err,data){that.callback(peerId,err,data)});return this.options&&Array.isArray(this.options.subIds)&&(this.options.subIds[peerId]=subId),subId},DiyaSelector.prototype.listen=function(){},DiyaSelector.prototype.__old_deprecated_unsubscribe=function(subIds){return this.each(function(peerId){var subId=subIds[peerId];subId&&connection.unsubscribe(subId)}),this},module.exports=d1},{"./DiyaNode":3,inherits:1,"node-event-emitter":2}],5:[function(require,module,exports){var d1=require("./DiyaSelector.js");require("./services/rtc/rtc.js"),require("./services/peerAuth/PeerAuth.js"),require("./services/meshNetwork/MeshNetwork.js"),module.exports=d1},{"./DiyaSelector.js":4,"./services/meshNetwork/MeshNetwork.js":6,"./services/peerAuth/PeerAuth.js":7,"./services/rtc/rtc.js":8}],6:[function(require,module,exports){var DiyaSelector=require("../../DiyaSelector").DiyaSelector,d1=require("../../DiyaSelector");d1.knownPeers=function(){return d1("#self").knownPeers()},d1.kp=d1.knownPeers,DiyaSelector.prototype.knownPeers=function(callback){var deferred=Q.defer();return this.request({service:"meshNetwork",func:"ListKnownPeers"},function(peerId,err,data){if(err)return deferred.reject(err);for(var peers=[],i=0;i<data.peers.length;i++)peers.push(data.peers[i].name);return deferred.resolve(peers)}),deferred.promise},d1.listenMeshNetwork=function(callback){return d1(/.*/).subscribe({service:"meshNetwork",func:"SubscribeMeshNetwork"},callback,{auto:!0})}},{"../../DiyaSelector":4}],7:[function(require,module,exports){var DiyaSelector=require("../../DiyaSelector").DiyaSelector,d1=require("../../DiyaSelector");"undefined"==typeof INFO&&(INFO=function(s){console.log(s)}),"undefined"==typeof OK&&(OK=function(s){console.log(s)}),d1.installNodeExt=function(ip,user,password,bootstrap_ip,bootstrap_user,bootstrap_password,bootstrap_net,callback){function join(peer,bootstrap_peer){d1("#self").join(bootstrap_net,!0,function(peer,err,data){return err||OK("JOINED !!!"),callback(peer,bootstrap_peer,err,data)})}if("string"!=typeof ip)throw"[installNode] ip should be an IP address";if("string"!=typeof bootstrap_ip)throw"[installNode] bootstrap_ip should be an IP address";if("string"!=typeof bootstrap_net)throw"[installNode] bootstrap_net should be an IP address";0!==bootstrap_ip.indexOf("ws://")&&0!==bootstrap_ip.indexOf("wss://")&&(bootstrap_ip=d1.isSecured()?"wss://"+bootstrap_ip:"ws://"+bootstrap_ip),0!==bootstrap_net.indexOf("ws://")&&0!==bootstrap_net.indexOf("wss://")&&(bootstrap_net=d1.isSecured()?"wss://"+bootstrap_net:"ws://"+bootstrap_net),d1.connectAsUser(ip,user,password).then(function(peer,err,data){d1("#self").givePublicKey(function(peer,err,data){return"ServiceNotFound"===err?(INFO("Peer Authentication disabled ... directly joining"),void join()):err?callback(peer,null,err,null):(INFO("Add trusted peer "+peer+"(ip="+ip+") to "+bootstrap_ip+" with public key "+data.public_key.slice(0,20)),void d1.connectAsUser(bootstrap_ip,bootstrap_user,bootstrap_password).then(function(){d1("#self").addTrustedPeer(peer,data.public_key,function(bootstrap_peer,err,data){return err?callback(peer,bootstrap_peer,err,null):(data.alreadyTrusted?INFO(peer+" already trusted by "+bootstrap_peer):INFO(bootstrap_peer+"(ip="+bootstrap_ip+") added "+peer+"(ip="+ip+") as a Trusted Peer"),INFO("In return, add "+bootstrap_peer+" to "+peer+" as a Trusted Peer with public key "+data.public_key.slice(0,20)),void d1.connectAsUser(ip,user,password).then(function(){d1("#self").addTrustedPeer(bootstrap_peer,data.public_key,function(peer,err,data){return err?callback(peer,bootstrap_peer,err,null):data.alreadyTrusted?INFO(bootstrap_peer+" already trusted by "+peer):INFO(peer+"(ip="+ip+") added "+bootstrap_peer+"(ip="+bootstrap_ip+") as a Trusted Peer"),OK("KEYS OK ! Now, let "+peer+"(ip="+ip+") join the network via "+bootstrap_peer+"(ip="+bootstrap_net+") ..."),join(peer,bootstrap_peer)})}))})}))})})},d1.installNode=function(bootstrap_ip,bootstrap_net,callback){var ip=d1.addr(),user=d1.user(),password=d1.pass(),bootstrap_user=user,bootstrap_password=password;return d1.installNodeExt(ip,user,password,bootstrap_ip,bootstrap_user,bootstrap_password,bootstrap_net,callback)},DiyaSelector.prototype.join=function(bootstrap_ips,bPermanent,callback){if("string"==typeof bootstrap_ips&&(bootstrap_ips=[bootstrap_ips]),bootstrap_ips.constructor!==Array)throw"join() : bootstrap_ips should be an array of peers URIs";this.request({service:"meshNetwork",func:"Join",data:{bootstrap_ips:bootstrap_ips,bPermanent:bPermanent}},function(peerId,err,data){"function"==typeof callback&&callback(peerId,err,data)})},DiyaSelector.prototype.leave=function(bootstrap_ips,bPermanent,callback){if("string"==typeof bootstrap_ips&&(bootstrap_ips=[bootstrap_ips]),bootstrap_ips.constructor!==Array)throw"leave() : bootstrap_ips should be an array of peers URIs";this.request({service:"meshNetwork",func:"Leave",data:{bootstrap_ips:bootstrap_ips,bPermanent:bPermanent}},function(peerId,err,data){"function"==typeof callback&&callback(peerId,err,data)})},DiyaSelector.prototype.givePublicKey=function(callback){return this.request({service:"peerAuth",func:"GivePublicKey",data:{}},function(peerId,err,data){callback(peerId,err,data)})},DiyaSelector.prototype.addTrustedPeer=function(name,public_key,callback){return this.request({service:"peerAuth",func:"AddTrustedPeer",data:{name:name,public_key:public_key}},function(peerId,err,data){callback(peerId,err,data)})},DiyaSelector.prototype.areTrusted=function(peers,callback){return this.request({service:"peerAuth",func:"AreTrusted",data:{peers:peers}},function(peerId,err,data){var allTrusted=data.trusted;allTrusted?(OK(peers+" are trusted by "+peerId),callback(peerId,!0)):(ERR("Some peers in "+peers+" are untrusted by "+peerId),callback(peerId,!1))})},DiyaSelector.prototype.isTrusted=function(peer,callback){return this.areTrusted([peer],callback)},d1.trustedPeers=function(){var deferred=Q.defer();return d1("#self").request({service:"peerAuth",func:"GetTrustedPeers"},function(peerId,err,data){if(err)return deferred.reject(err);for(var peers=[],i=0;i<data.peers.length;i++)peers.push(data.peers[i].name);return deferred.resolve(peers)}),deferred.promise},d1.tp=d1.trustedPeers},{"../../DiyaSelector":4}],8:[function(require,module,exports){function Channel(dnId,name,open_cb){EventEmitter.call(this),this.name=name,this.dnId=dnId,this.frequency=20,this.channel=void 0,this.onopen=open_cb,this.closed=!1}function Peer(dnId,rtc,id,channels){this.dn=d1(dnId),this.dnId=dnId,this.id=id,this.channels=channels,this.rtc=rtc,this.peer=null,this.connected=!1,this.closed=!1,this._connect()}function RTC(selector){this.selector=selector,this.requestedChannels=[]}function createNeuronsFromDOM(domNode,selectedNodes,rtc){if(domNode&&domNode.querySelectorAll){for(var neuronNodeList=domNode.querySelectorAll("*"),neuronNodes=[],i=0;i<neuronNodeList.length;i++)isNeuronTag(neuronNodeList[i])&&(neuronNodes.push(neuronNodeList[i]),Array.isArray(selectedNodes)&&selectedNodes.push(neuronNodeList[i]));neuronNodes.forEach(function(neuronNode){var channel=getChannel(neuronNode.attributes.name.value);
rtc.use(channel,function(dnId,neuron){neuronNode.setNeuron(dnId,neuron)})})}}function isNeuronTag(node){return node.tagName.startsWith("NEURON-")&&node.attributes.name&&"function"==typeof node.setNeuron}function getChannel(name){return name.replace(/\s+/,"")}if(DiyaSelector=require("../../DiyaSelector").DiyaSelector,EventEmitter=require("node-event-emitter"),inherits=require("inherits"),"undefined"!=typeof window)var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;inherits(Channel,EventEmitter),Channel.prototype.setChannel=function(datachannel){this.channel=datachannel,this.channel.binaryType="arraybuffer",this._negociate()},Channel.prototype.close=function(){this.closed=!0},Channel.prototype.write=function(index,value){return 0>index||index>this.size||isNaN(value)?!1:(this._buffer[index]=value,this._requestSend(),!0)},Channel.prototype.writeAll=function(values){if(!Array.isArray(values)||values.length!==this.size)return!1;for(var i=0;i<values.length;i++){if(isNaN(values[i]))return!1;this._buffer[i]=values[i]}this._requestSend()},Channel.prototype._requestSend=function(){function doSend(){that._sendRequested=!1,that._lastSendTimestamp=(new Date).getTime();var ret=that._send(that._buffer);ret&&that.autosend&&that._requestSend()}var that=this,elapsedTime=(new Date).getTime()-this._lastSendTimestamp,period=1e3/this.frequency;elapsedTime>=period?doSend():this._sendRequested||(this._sendRequested=!0,setTimeout(doSend,period-elapsedTime))},Channel.prototype._send=function(msg){if(this.closed)return!1;if("open"===this.channel.readyState){try{this.channel.send(msg)}catch(e){console.log("[rtc.channel.write] exception occured while sending data")}return!0}return console.log("[rtc.channel.write] warning : webrtc datachannel state = "+this.channel.readyState),!1},Channel.prototype._negociate=function(){var that=this;this.channel.onmessage=function(message){var view=new DataView(message.data),typeChar=String.fromCharCode(view.getUint8(0));"O"===typeChar?that.type="input":"I"===typeChar&&(that.type="output");var size=view.getInt32(1,!0);void 0!=size&&(that.size=size,that._buffer=new Float32Array(size)),that.channel.onmessage=that._onMessage.bind(that),that.channel.onclose=that._onClose.bind(that),"function"==typeof that.onopen&&that.onopen(that.dnId,that),console.log("channel "+that.name+" negociated !")}},Channel.prototype._onMessage=function(message){var valArray=new Float32Array(message.data);this.emit("value",valArray)},Channel.prototype._onClose=function(){console.log("channel "+this.name+" closed !"),this.emit("close")},Peer.prototype._connect=function(){var that=this;this.subscription=this.dn.subscribe({service:"rtc",func:"Connect",obj:this.channels,data:{promID:this.id}},function(diya,err,data){data&&that._handleNegociationMessage(data)}),setTimeout(function(){that.connected||that.closed||that._reconnect()},1e4)},Peer.prototype._reconnect=function(){this.close(),this.peer=null,this.connected=!1,this.closed=!1,this._connect()},Peer.prototype._handleNegociationMessage=function(msg){"RemoteOffer"===msg.eventType?this._createPeer(msg):"RemoteICECandidate"===msg.eventType&&this._addRemoteICECandidate(msg)};var servers={iceServers:[{url:"stun:stun.l.google.com:19302"}]};Peer.prototype._createPeer=function(data){var that=this,peer=new RTCPeerConnection(servers,{mandatory:[{DtlsSrtpKeyAgreement:!0},{EnableDtlsSrtp:!0}]});this.peer=peer,peer.setRemoteDescription(new RTCSessionDescription({sdp:data.sdp,type:data.type})),peer.createAnswer(function(session_description){peer.setLocalDescription(session_description),that.dn.request({service:"rtc",func:"Answer",data:{promID:data.promID,peerId:data.peerId,sdp:session_description.sdp,type:session_description.type}})},function(err){console.log("RTC: cannot create answer :"),console.log(err)},{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}),peer.oniceconnectionstatechange=function(){console.log("RTC: state change("+that.id+":"+that.dnId+") : "+peer.iceConnectionState),"connected"===peer.iceConnectionState?(that.connected=!0,that.subscription&&that.subscription.close()):"disconnected"===peer.iceConnectionState&&(that.closed||that._reconnect())},peer.onicecandidate=function(evt){console.log("local candidate : "),console.log(evt.candidate),that.dn.request({service:"rtc",func:"ICECandidate",data:{peerId:data.peerId,promID:that.id,candidate:evt.candidate}})},peer.ondatachannel=function(evt){that.connected=!0,that.rtc._onDataChannel(that.dnId,evt.channel)}},Peer.prototype._addRemoteICECandidate=function(data){var that=this;console.log("remote candidate : "),console.log(data.candidate);try{var candidate=new RTCIceCandidate(data.candidate);this.peer.addIceCandidate(candidate,function(){console.log("RTC: candidate added("+that.id+":"+that.dnId+") : "+that.peer.iceConnectionState)},function(err){console.error("RTC: cannot add RemoteICECandidate :"),console.error(err)})}catch(err){console.error("RTC: cannot add RemoteICECandidate : "),console.error(err)}},Peer.prototype.close=function(){if(this.subscription&&this.subscription.close(),this.peer){try{this.peer.close()}catch(e){}this.connected=!1,this.closed=!0}},RTC.prototype.disconnect=function(){var that=this;return this.selector.each(function(dnId){if(that[dnId])for(var promID in that[dnId].peers)that._closePeer(dnId,promID)}),this.subscription&&this.subscription.close(),this},RTC.prototype.use=function(name_regex,onopen_callback){return this.requestedChannels.push({regex:name_regex,cb:onopen_callback}),this},RTC.prototype.connect=function(){var that=this;return this.subscription=this.selector.subscribe({service:"rtc",func:"ListenPeers"},function(dnId,err,data){if(that[dnId]||that._createDiyaNode(dnId),"SubscriptionClosed"===err||"PeerDisconnected"===err)return void that._closeDiyaNode(dnId);if(data&&data.eventType&&void 0!==data.promID)if("PeerConnected"===data.eventType){if(!that[dnId].peers[data.promID]){var channels=that._matchChannels(dnId,data.channels);channels.length>0&&(that[dnId].peers[data.promID]=new Peer(dnId,that,data.promID,channels))}}else"PeerClosed"===data.eventType&&that[dnId].peers[data.promID]&&(that._closePeer(dnId,data.promID),"function"==typeof that.onclose&&that.onclose(dnId))},{auto:!0}),this},RTC.prototype._createDiyaNode=function(dnId){var that=this;this[dnId]={dnId:dnId,usedChannels:[],requestedChannels:[],peers:[]},this.requestedChannels.forEach(function(c){that[dnId].requestedChannels.push(c)})},RTC.prototype._closeDiyaNode=function(dnId){for(var promID in this[dnId].peers)this._closePeer(dnId,promID);delete this[dnId]},RTC.prototype._closePeer=function(dnId,promID){if(this[dnId].peers[promID]){var p=this[dnId].peers[promID];p.close();for(var i=0;i<p.channels.length;i++)delete this[dnId].usedChannels[p.channels[i]];delete this[dnId].peers[promID]}},RTC.prototype._matchChannels=function(dnId,receivedChannels){for(var that=this,channels=[],i=0;i<receivedChannels.length;i++)for(var name=receivedChannels[i],j=0;j<that[dnId].requestedChannels.length;j++){var req=that[dnId].requestedChannels[j];name&&name.match(req.regex)&&!that[dnId].usedChannels[name]&&(that[dnId].usedChannels[name]=new Channel(dnId,name,req.cb),channels.push(name))}return channels},RTC.prototype._onDataChannel=function(dnId,datachannel){var channel=this[dnId].usedChannels[datachannel.label];return channel?(console.log("Channel "+datachannel.label+" created !"),void channel.setChannel(datachannel)):(console.log("Channel "+datachannel.label+" unmatched, closing !"),void datachannel.close())},DiyaSelector.prototype.rtc=function(domNode,selectedNodes){var rtc=new RTC(this);return domNode&&createNeuronsFromDOM(domNode,selectedNodes,rtc),rtc}},{"../../DiyaSelector":4,inherits:1,"node-event-emitter":2}]},{},[5])(5)});
