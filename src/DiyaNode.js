var Q = require('q');
var EventEmitter = require('node-event-emitter');
var inherits = require('inherits');

//////////////////////////////////////////////////////////////
/////////////////// Logging utility methods //////////////////
//////////////////////////////////////////////////////////////

var DEBUG = true;
var Logger = {
	log: function(message){
		if(DEBUG) console.log(message);
	},

	error: function(message){
		if(DEBUG) console.error(message);
	}
}

//////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////


function DiyaNode(addr){
	EventEmitter.call(this);

	this._addr = addr;
	this._socket = null;
	this._nextId = 0;
	this._connectionDeferred = null;
	this._pendingMessages = [];
	this._peers = [];
}
inherits(DiyaNode, EventEmitter);

////////////////////////////////////////////////////
////////////////// Public API //////////////////////
////////////////////////////////////////////////////

DiyaNode.prototype.connect = function(WSocket){
	var that = this;
	this._connectionDeferred = Q.defer();

	if(!WSocket) WSocket = window.WebSocket;
	this._socket = new WSocket(this._addr);

	this._socket.onopen = function(){
		that._socket.onclose = that._onclose.bind(that);
		that._socket.onmessage = that._onmessage.bind(that);
	}
	this._socket.onerror = function(err){
		if(that._connectionDeferred.promise.isFulfilled()){
			Logger.error("[WS] error : "+err);
		}else {
			that._connectionDeferred.reject(err);
		}
	}

	return this._connectionDeferred.promise;
};

DiyaNode.prototype.close = function(){
	if(this._socket) this._socket.close();
};


DiyaNode.prototype.request = function(params, callback, timeout){
	var that = this;

	if(!params.service) {
		Logger.error('No service defined for request !');
		return ;
	}

	var message = this._createMessage(params, "Request");
	this._appendMessage(message, callback);

	if(!isNaN(timeout) && timeout > 0){
		setTimeout(function(){
			var handler = that._removeMessage(message.id);
			if(handler) that._notifyListener(handler, 'Timeout exceeded ('+timeout+'ms) !');
		}, timeout);
	}

	if(!this._send(message)){
		this._removeMessage(message.id);
		Logger.error('Cannot send request !');
		return false;
	}

	return true;
};

DiyaNode.prototype.subscribe = function(params, callback){
	if(!params.service){
		Logger.error('No service defined for subscription !');
		return ;
	}

	var message = this._createMessage(params, "Subscription");
	this._appendMessage(message, callback);

	if(!this._send(message)){
		this._removeMessage(message.id);
		Logger.error('Cannot send subscription !');
		return -1;
	}

	return message.id;
};

DiyaNode.prototype.unsubscribe = function(subId){
	if(this._pendingMessages[subId] && this._pendingMessages[subId].type === "Subscription"){
		var subscription = this._removeMessage(subId);

		var message = this._createMessage({
			target: subscription.target,
			data: {
				subId: subId
			}
		}, "Unsubscribe");

		if(!this._send(message)){
			Logger.error('Cannot send unsubscribe !');
			return false;
		}

		return true;
	}
};

DiyaNode.prototype.peers = function(){
	return this._peers;
}

///////////////////////////////////////////////////////////
//////////////////// Internal methods /////////////////////
///////////////////////////////////////////////////////////

DiyaNode.prototype._appendMessage = function(message, callback){
	this._pendingMessages[message.id] = {
		callback: callback,
		type: message.type,
		target: message.target
	};
};

DiyaNode.prototype._removeMessage = function(messageId){
	var handler = this._pendingMessages[messageId];
	if(handler){
		delete this._pendingMessages[messageId];
		return handler;
	}else{
		return null;
	}
};

DiyaNode.prototype._clearMessages = function(err, data){
	for(var messageId in this._pendingMessages){
		var handler = this._removeMessage(messageId);
		this._notifyListener(handler, err, data);
	}
};

DiyaNode.prototype._getMessageHandler = function(messageId){
	var handler = this._pendingMessages[messageId];
	return handler ? handler : null;
};

DiyaNode.prototype._notifyListener = function(handler, error, data){
	if(handler && typeof handler.callback === 'function') {
		error = error ? error : null;
		data = data ? data : null;
		handler.callback(error, data);
	}
};

DiyaNode.prototype._send = function(message){
	try{
		var data = JSON.stringify(message);
	}catch(err){
		Logger.error('Cannot serialize message');
		return false;
	}

	try{
		this._socket.send(data);
	}catch(err){
		Logger.error('Cannot send message');
		return false;
	}

	return true;
}

///////////////////////////////////////////////////////////////
/////////////////// Socket event handlers /////////////////////
///////////////////////////////////////////////////////////////

DiyaNode.prototype._onmessage = function(evt){
	try{
		var message = JSON.parse(evt.data);
	}catch(err){
		Logger.error("[WS] cannot parse message, dropping...");
		return ;
	}

	if(isNaN(message.id)) {
		this._handleInternalMessage(message);
	}else{
		var handler = this._getMessageHandler(message.id);
		if(handler){
			switch(handler.type){
				case "Request":
					this._handleRequest(handler, message);
					break;
				case "Subscription":
					this._handleSubscription(handler, message);
					break;
			}
		}
	}
};

DiyaNode.prototype._onclose = function(){
	Logger.log("[WS] connection closed !");
	this._clearMessages();
	this.emit('close');
};

/////////////////////////////////////////////////////////////
/////////////// Protocol event handlers /////////////////////
/////////////////////////////////////////////////////////////

DiyaNode.prototype._handleInternalMessage = function(message){
	switch(message.type){
		case "PeerConnected":
			this._handlePeerConnected(message);
			break;
		case "PeerDisconnected":
			this._handlePeerDisconnected(message);
			break;
		case "Handshake":
			this._handleHandshake(message);
			break;
	}
};

DiyaNode.prototype._handleHandshake = function(message){
	if(message.peers === undefined){
		Logger.error("Missing argumnents for Handshake message, dropping...");
		return ;
	}

	for(var i=0;i<message.peers.length; i++){
		this._peers.push(message.peers[i]);
	}

	if(this._connectionDeferred && !this._connectionDeferred.promise.isFulfilled()){
		this._connectionDeferred.resolve();
		this.emit('open');
		this._connectionDeferred = null;
	}
};

DiyaNode.prototype._handlePeerConnected = function(message){
	if(message.peerId === undefined){
		Logger.error("Missing arguments for PeerConnected message, dropping...");
		return ;
	}

	//Add peer to the list of reachable peers
	this._peers.push(message.peerId);

	this.emit('peer-connected', message.peerId);
};

DiyaNode.prototype._handlePeerDisconnected = function(message){
	if(message.peerId === undefined){
		Logger.error("Missing arguments for PeerDisconnected Message, dropping...");
		return ;
	}

	//Go through all pending messages and notify the ones that are targeted
	//at the disconnected peer that it disconnected and therefore the command
	//cannot be fulfilled
	for(var messageId in this._pendingMessages){
		var handler = this._getMessageHandler(messageId);
		if(handler && handler.target === message.peerId) {
			this._removeMessage(messageId);
			this._notifyListener(handler, 'PeerDisconnected', null);
		}
	}

	//Remove peer from list of reachable peers
	for(var i=this._peers.length - 1; i >= 0; i--){
		if(this._peers[i] === message.peerId){
			this._peers.splice(i, 1);
			break;
		}
	}

	this.emit('peer-disconnected', message.peerId);
};

DiyaNode.prototype._handleRequest = function(handler, message){
	this._removeMessage(message.id);
	this._notifyListener(handler, message.error, message.data);
};

DiyaNode.prototype._handleSubscription = function(handler, message){
	//remove subscription if it was closed from node
	if(message.result === "closed") {
		this._removeMessage(message.id);
		message.error = 'SubscriptionClosed';
	}
	this._notifyListener(handler, message.error, message.data ? message.data : null);
};

///////////////////////////////////////////////////////////////
////////////////////// Utility methods ////////////////////////
///////////////////////////////////////////////////////////////

DiyaNode.prototype._createMessage = function(params, type){
	if(!params || !type || (type !== "Request" && type !== "Subscription" && type !== "Unsubscribe")){
		return null;
	}

	return {
		type: type,
		id: this._generateId(),
		service: params.service,
		target: params.target,
		token: params.token,
		func: params.func,
		obj: params.obj,
		data: params.data
	}
};

DiyaNode.prototype._generateId = function(){
	var id = this._nextId;
	this._nextId++;
	return id;
};



module.exports = DiyaNode;
